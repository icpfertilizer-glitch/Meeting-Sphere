<!doctype html>
<html lang="th" data-bs-theme="light">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Dashboard • สถานะห้องประชุม</title>

  <!-- Bootstrap + Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet"/>
  
  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet"/>

  <style>
    :root{
      --radius: 20px;
      --shadow: 0 8px 32px rgba(0,0,0,.08), 0 4px 16px rgba(0,0,0,.04);
      --shadow-hover: 0 12px 48px rgba(0,0,0,.12), 0 8px 24px rgba(0,0,0,.08);
      --ring: 0 0 0 3px rgba(13,110,253,.15);
      --gradient-bg: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      --glass: rgba(255,255,255,.85);
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif; overflow-x: auto; }
    body { margin: 0; background: var(--gradient-bg); background-attachment: fixed; position: relative; }
    body::before {
      content: ''; position: fixed; inset: 0; pointer-events: none; z-index: -1;
      background:
        radial-gradient(circle at 20% 20%, rgba(255,255,255,.1) 0%, transparent 50%),
        radial-gradient(circle at 80% 80%, rgba(255,255,255,.08) 0%, transparent 50%),
        radial-gradient(circle at 40% 60%, rgba(120,119,198,.3) 0%, transparent 50%);
    }

    /* Container หลัก */
    .board { min-height: 100vh; padding: 20px; display: flex; flex-direction: column; }

    /* Header */
    .board-head{
      display:flex; align-items:center; justify-content:space-between; gap:20px;
      margin-bottom:30px; background:var(--glass); backdrop-filter: blur(20px);
      border:1px solid rgba(255,255,255,.3); border-radius:var(--radius);
      padding:20px 30px; box-shadow:var(--shadow); flex-wrap: wrap;
    }

    .now-chip{
      background: linear-gradient(135deg,#667eea,#764ba2); color:#fff; border:none;
      border-radius:16px; padding:12px 20px; font-weight:700; font-size:1rem;
      box-shadow:0 4px 16px rgba(102,126,234,.3); font-variant-numeric: tabular-nums; letter-spacing:.5px;
      display:block; width:100%; text-align:center;
      line-height:1.25;
    }
    .now-chip i{ opacity:.9; margin-right:6px; }
    .now-chip .sep{ opacity:.6; margin: 0 .5rem; }
    .util{ display:flex; align-items:center; gap:12px; flex: 0 0 100%; width:100%; }

    /* Grid การ์ด */
    .rooms-grid{ display:grid; grid-template-columns: repeat(auto-fit, minmax(380px,1fr)); gap:24px; flex:1; }
    @media (min-width:1400px){ .rooms-grid{ grid-template-columns: repeat(3,1fr);} }
    @media (min-width:1800px){ .rooms-grid{ grid-template-columns: repeat(4,1fr);} }

    /* การ์ดห้อง */
    .room-card{
      --h:210; background:var(--glass); backdrop-filter: blur(20px);
      border:1px solid rgba(255,255,255,.3); border-radius:var(--radius);
      padding:24px; box-shadow:var(--shadow); transition: all .4s cubic-bezier(.4,0,.2,1);
      position:relative; overflow:hidden; min-height:320px; display:flex; flex-direction:column;
      opacity:0; transform: translateY(8px); animation: fadeUp .5s ease forwards;
    }
    @keyframes fadeUp{ to{ opacity:1; transform: translateY(0); } }

    .room-card::before{ content:''; position:absolute; top:0; left:0; right:0; height:4px;
      background: linear-gradient(90deg, hsl(var(--h),60%,60%), hsl(var(--h),70%,70%));
      border-radius: var(--radius) var(--radius) 0 0;
    }
    .room-card:hover{ transform: translateY(-6px); box-shadow:var(--shadow-hover); border-color: rgba(255,255,255,.5); }

    .room-title{ display:flex; align-items:center; justify-content:space-between; flex-wrap:wrap; margin-bottom:16px; gap:12px; }
    .room-name{ display:flex; align-items:center; gap:10px; font-weight:800; font-size:1.15rem; color:rgba(0,0,0,.85); }
    .room-name .color-dot{ width:12px; height:12px; border-radius:50%; background:hsl(var(--h),65%,55%); box-shadow:0 0 0 6px hsla(var(--h),65%,55%,.15); animation:pulse-room 3s ease-in-out infinite; }
    @keyframes pulse-room{ 0%,100%{box-shadow:0 0 0 6px hsla(var(--h),65%,55%,.15)} 50%{box-shadow:0 0 0 10px hsla(var(--h),65%,55%,.25)} }

    .meta-info{ display:flex; gap:8px; flex-wrap:wrap; margin-bottom:8px; }
    .meta-pill{ background:hsla(var(--h),100%,97%,.85); color:hsl(var(--h),50%,35%); border:1px solid hsla(var(--h),40%,70%,.3); border-radius:18px; padding:4px 10px; font-size:.78rem; font-weight:600; backdrop-filter: blur(10px); }

    .live-pill{ display:inline-flex; align-items:center; gap:8px; padding:6px 12px; border-radius:18px; font-weight:700; font-size:.82rem; border:2px solid; backdrop-filter: blur(10px); transition: all .3s ease; }
    .live-pill .beacon{ width:8px; height:8px; border-radius:50%; }
    .live-free{ background: rgba(25,135,84,.15); border-color: rgba(25,135,84,.4); color:#0a5d2c; }
    .live-free .beacon{ background:#198754; animation:pulseFree 1.5s infinite; }
    .live-busy{ background: rgba(220,53,69,.15); border-color: rgba(220,53,69,.4); color:#842029; }
    .live-busy .beacon{ background:#dc3545; animation:pulseBusy 1.5s infinite; }
    @keyframes pulseFree{ 0%{box-shadow:0 0 0 0 rgba(25,135,84,.7)} 70%{box-shadow:0 0 0 6px rgba(25,135,84,0)} 100%{box-shadow:0 0 0 0 rgba(25,135,84,0)} }
    @keyframes pulseBusy{ 0%{box-shadow:0 0 0 0 rgba(220,53,69,.7)} 70%{box-shadow:0 0 0 6px rgba(220,53,69,0)} 100%{box-shadow:0 0 0 0 rgba(220,53,69,0)} }

    .section-label{ display:flex; align-items:center; gap:8px; font-weight:800; font-size:.9rem; color:rgba(0,0,0,.65); margin:12px 0 8px; position:relative; }
    .section-label i{ opacity:.9; }
    .section-label::after{ content:""; flex:1; height:1px; background: linear-gradient(90deg, hsla(var(--h),50%,70%,.35), transparent); }

    .section-content{ flex:1; display:flex; flex-direction:column; gap:8px; }

    .status-item{ display:flex; align-items:center; justify-content:space-between; gap:12px; background:rgba(255,255,255,.65); backdrop-filter: blur(10px); border:1px solid rgba(255,255,255,.45); border-radius:12px; padding:10px 14px; transition: all .25s ease; }
    .status-item:hover{ background: rgba(255,255,255,.85); transform: translateX(3px); }
    .status-left{ display:flex; align-items:center; gap:8px; min-width:0; }
    .status-left i{ opacity:.7; }
    .status-time{ font-variant-numeric: tabular-nums; font-weight:800; padding:6px 10px; border-radius:10px; background:hsla(var(--h),100%,98%,.9); border:1px solid hsla(var(--h),40%,70%,.25); color:hsl(var(--h),50%,35%); font-size:.82rem; }
    .status-who{ color:rgba(0,0,0,.65); font-size:.9rem; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:60%; font-weight:600; }

    .progress-wrap{ background: rgba(255,255,255,.4); backdrop-filter: blur(10px); border:1px solid rgba(255,255,255,.3); border-radius:8px; height:8px; overflow:hidden; margin-top:4px; }
    .progress-bar{ height:100%; background: linear-gradient(90deg, hsl(var(--h),60%,55%), hsl(var(--h),70%,65%)); transition: width .3s ease; border-radius:8px; }

    /* ป้ายเพิ่งจบ */
    .badge-soft{
      display:inline-flex; align-items:center; gap:6px; padding:4px 8px; border-radius:999px; font-weight:800; font-size:.72rem;
      background: rgba(108,117,125,.12); border:1px solid rgba(108,117,125,.28); color:#495057;
    }
    .badge-soft i{ opacity:.8; }

    /* ปุ่มลอย (เต็มจอ) */
    .fab{
      position: fixed; right: 20px; bottom: 20px; z-index: 9999;
      background: var(--glass); backdrop-filter: blur(12px);
      border: 1px solid rgba(255,255,255,.5);
      border-radius: 999px; padding: 12px 16px;
      font-weight: 700; box-shadow: var(--shadow); cursor: pointer;
      display: inline-flex; align-items:center; gap:8px;
    }
    .fab:hover{ box-shadow: var(--shadow-hover); transform: translateY(-2px); }
    .fab:focus-visible{ outline:0; box-shadow: var(--ring); }

    /* Responsive */
    @media (max-width:768px){
      .rooms-grid{ grid-template-columns:1fr; gap:16px; }
      .board{ padding:16px; }
      .board-head{ padding:16px; }
    }
  </style>
</head>
<body>
  <main class="board">
    <div class="board-head">
      <div class="util">
        <span id="nowTime" class="now-chip">
          <i class="bi bi-calendar3"></i> — — — <span class="sep">•</span><i class="bi bi-clock"></i> —:— น.
        </span>
      </div>
    </div>

    <div id="roomsGrid" class="rooms-grid"></div>
  </main>

  <!-- ปุ่มลอยมุมขวาล่าง -->
  <button id="btnFullscreen" class="fab">
    <i class="bi bi-arrows-fullscreen"></i> เต็มจอ
  </button>

  <!-- Firebase (ESM) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-app.js";
    import { getFirestore, collection, onSnapshot, query, orderBy, where } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-firestore.js";

    /* ============== CONFIG ============== */
    const firebaseConfig = {
      apiKey: "AIzaSyB_G4hfiis6DjmPiwsh5-hnNKVztMfd_T4",
      authDomain: "booking-sw.firebaseapp.com",
      projectId: "booking-sw",
      storageBucket: "booking-sw.firebasestorage.app",
      messagingSenderId: "134246403096",
      appId: "1:134246403096:web:900da94277e8b70c4cc76d"
    };

    /* ============== INIT ============== */
    const app = initializeApp(firebaseConfig);
    const db  = getFirestore(app);
    const roomsRef = collection(db, "meeting_rooms");
    const meetingsRef = collection(db, "meetings");

    const $ = (s) => document.querySelector(s);
    const nowEl = $("#nowTime");
    const grid = $("#roomsGrid");

    const fmt2 = (n) => String(n).padStart(2,"0");
    const toYmd = (d) => [d.getFullYear(), fmt2(d.getMonth()+1), fmt2(d.getDate())].join("-");
    const hm2m = (s) => { const [h,m] = (s||"0:0").split(":").map(x => +x||0); return h*60+m; };
    const clamp = (v,min,max)=> Math.max(min, Math.min(max,v));

    /* ===== เวลา: แสดงวันที่ + เวลา (ไทย) ===== */
    function thaiDateString(d){
      // เช่น "พฤหัสบดี 11 ก.ย. 2568"
      const opts = { weekday:'long', year:'numeric', month:'short', day:'numeric' };
      // th-TH จะเป็น พ.ศ. โดยอัตโนมัติ
      return d.toLocaleDateString('th-TH', opts);
    }
    function tickClock(){
      const d = new Date();
      const timeTxt = `${fmt2(d.getHours())}:${fmt2(d.getMinutes())}`;
      nowEl.innerHTML = `<i class="bi bi-calendar3"></i> ${thaiDateString(d)} <span class="sep">•</span> <i class="bi bi-clock"></i> ${timeTxt} น.`;
    }
    tickClock();
    setInterval(tickClock, 1_000);

    /* ===== UI Builders ===== */
    function hueFromString(s){
      if(!s) return 210;
      let h=0; for(let i=0;i<s.length;i++){ h=(h*31 + s.charCodeAt(i)) % 360; }
      return Math.round((h/360)*330);
    }

    function makeSectionLabel(icon, text, h){
      const div=document.createElement("div");
      div.className="section-label";
      div.style.setProperty("--h", h);
      div.innerHTML=`<i class="bi ${icon}"></i> ${text}`;
      return div;
    }

    function makeStatusItem(h, timeText, whoText, leadingIcon=null, trailingNode=null){
      const wrap=document.createElement("div");
      wrap.className="status-item";
      wrap.style.setProperty("--h", h);

      const left=document.createElement("div");
      left.className="status-left";
      if (leadingIcon){
        const ic = document.createElement("i");
        ic.className = `bi ${leadingIcon}`;
        left.appendChild(ic);
      }

      const time=document.createElement("span");
      time.className="status-time";
      time.textContent=timeText;

      const who=document.createElement("div");
      who.className="status-who";
      who.textContent=(whoText||"").trim() || "—";

      left.appendChild(time);
      left.appendChild(who);
      wrap.appendChild(left);

      if (trailingNode) wrap.appendChild(trailingNode);
      return wrap;
    }

    function makeProgress(h, startHM, endHM){
      const from = hm2m(startHM), to = hm2m(endHM);
      const nowM = (new Date()).getHours()*60 + (new Date()).getMinutes();
      const pct = clamp(((nowM - from) / (to - from)) * 100, 0, 100);

      const wrap=document.createElement("div");
      wrap.className="progress-wrap";
      wrap.style.setProperty("--h", h);

      const bar=document.createElement("div");
      bar.className="progress-bar";
      bar.style.width = `${isFinite(pct)?pct:0}%`;

      wrap.appendChild(bar);
      return wrap;
    }

    function makeEmptyState(text){
      const div=document.createElement("div");
      div.className="empty-state";
      div.textContent=text;
      return div;
    }

    /* ====== Render ====== */
    function renderBoard(rooms, meetingsToday){
      grid.innerHTML="";

      // กลุ่มห้อง
      const grouped={};
      rooms.forEach(r=> grouped[r.id]={ meta:r, prev:[], now:[], next:[] });

      // ใส่ meetings วันนี้
      const now = new Date();
      const nowM = now.getHours()*60 + now.getMinutes();

      meetingsToday.forEach(m=>{
        const rid = m.roomId || `misc:${m.roomName || "ห้อง"}`;
        if(!grouped[rid]) grouped[rid] = { meta:{ id:rid, name:m.roomName || "(ไม่มีชื่อ)" }, prev:[], now:[], next:[] };
        const s=hm2m(m.start), e=hm2m(m.end);
        if(e<=nowM) grouped[rid].prev.push(m);
        else if(s<=nowM && nowM<e) grouped[rid].now.push(m);
        else grouped[rid].next.push(m);
      });

      // วาดการ์ดตามชื่อ
      Object.values(grouped)
        .sort((a,b)=> (a.meta?.name||"").localeCompare(b.meta?.name||""))
        .forEach(g=>{
          const name = g.meta?.name || "(ไม่มีชื่อ)";
          const floor = g.meta?.location ?? g.meta?.floor ?? g.meta?.level ?? null;
          const cap   = g.meta?.capacity ?? g.meta?.cap ?? null;
          
          // Debug: แสดงข้อมูลห้องใน console
          console.log('Room data:', g.meta?.name, 'Floor:', floor, 'Raw data:', g.meta);
          const h = hueFromString(g.meta?.id || name);

          const card=document.createElement("div");
          card.className="room-card";
          card.style.setProperty("--h", h);

          const title=document.createElement("div");
          title.className="room-title";

          const nameDiv=document.createElement("div");
          nameDiv.className="room-name";
          // แสดงชื่อห้องพร้อม floor ในวงเล็บสีเทา
          const floorHtml = floor ? ` <small class="text-secondary">(ชั้น ${floor})</small>` : '';
          nameDiv.innerHTML=`<span class="color-dot"></span><span>${name}${floorHtml}</span>`;

          const live=document.createElement("span");
          const busy = g.now.length>0;
          live.className = `live-pill ${busy? "live-busy":"live-free"}`;
          live.innerHTML = `<span class="beacon"></span>${busy? "ไม่ว่าง":"ว่างตอนนี้"}`;

          title.appendChild(nameDiv);
          title.appendChild(live);
          card.appendChild(title);

          if (floor || cap){
            const meta=document.createElement("div");
            meta.className="meta-info";
            if (floor) meta.innerHTML += `<span class="meta-pill"><i class="bi bi-building"></i> ชั้น ${floor}</span>`;
            if (cap || cap===0) meta.innerHTML += `<span class="meta-pill"><i class="bi bi-people"></i> ${cap} คน</span>`;
            meta.innerHTML += `<span class="meta-pill"><i class="bi bi-calendar3"></i> วันนี้</span>`;
            card.appendChild(meta);
          }

          const content=document.createElement("div");
          content.className="section-content";

          /* ก่อนหน้า: โชว์ 1 รายการล่าสุดที่เพิ่งจบ */
          const prevSec=document.createElement("div");
          prevSec.appendChild(makeSectionLabel("bi-clock-history","ก่อนหน้า", h));
          if (g.prev.length){
            // ล่าสุด = จบช้าที่สุด
            g.prev.sort((a,b)=> (a.end||"").localeCompare(b.end||""));
            const last = g.prev[g.prev.length-1];
            const endM = hm2m(last.end);
            const diffMin = Math.max(0, nowM - endM); // นาทีตั้งแต่จบ

            let badge = null;
            if (diffMin <= 30){ // เพิ่งจบภายใน 30 นาที
              badge = document.createElement("span");
              badge.className = "badge-soft";
              badge.innerHTML = `<i class="bi bi-check2-circle"></i> เพิ่งจบ ${diffMin} นาทีที่แล้ว`;
            } else {
              badge = document.createElement("span");
              badge.className = "badge-soft";
              badge.innerHTML = `<i class="bi bi-flag"></i> จบ ${last.end} น.`;
            }

            prevSec.appendChild(
              makeStatusItem(h, `${last.start}–${last.end}`, last.bookerName||last.userName||"", "bi-person-check", badge)
            );
          } else {
            prevSec.appendChild(makeEmptyState("—"));
          }
          content.appendChild(prevSec);

          /* ขณะนี้ */
          const nowSec=document.createElement("div");
          nowSec.appendChild(makeSectionLabel("bi-broadcast-pin","ขณะนี้", h));
          if (g.now.length){
            g.now.sort((a,b)=> (a.start||"").localeCompare(b.start||""));
            g.now.forEach(m=>{
              nowSec.appendChild(makeStatusItem(h, `${m.start}–${m.end}`, m.bookerName||m.userName||"", "bi-dot"));
              nowSec.appendChild(makeProgress(h, m.start, m.end));
            });
          }else{
            nowSec.appendChild(makeEmptyState("ไม่มีการใช้งาน"));
          }
          content.appendChild(nowSec);

          /* ต่อไป */
          const nextSec=document.createElement("div");
          nextSec.appendChild(makeSectionLabel("bi-calendar-event","หลังจากนี้", h));
          if (g.next.length){
            g.next.sort((a,b)=> (a.start||"").localeCompare(b.start||""));
            g.next.slice(0,3).forEach(m=>{
              nextSec.appendChild(makeStatusItem(h, `${m.start}–${m.end}`, m.bookerName||m.userName||"", "bi-chevron-right"));
            });
          }else{
            nextSec.appendChild(makeEmptyState("ไม่มีการจองต่อ"));
          }
          content.appendChild(nextSec);

          card.appendChild(content);
          grid.appendChild(card);
        });
    }

    /* ============== DATA SUBSCRIPTIONS ============== */
    let rooms=[], todayMeetings=[];
    let unsubRooms, unsubToday;

    function subscribeRooms(){
      const qRooms = query(roomsRef, orderBy("name"));
      return onSnapshot(qRooms, snap=>{
        rooms = snap.docs.map(d=>({ id:d.id, ...d.data() })).filter(r=> r.isActive !== false);
        renderBoard(rooms, todayMeetings);
      });
    }

    function subscribeToday(){
      const today = toYmd(new Date());
      const qToday = query(meetingsRef, where("date","==", today));
      return onSnapshot(qToday, snap=>{
        todayMeetings = snap.docs.map(d=>({ id:d.id, ...d.data() }));
        renderBoard(rooms, todayMeetings);
      }, _err=>{
        todayMeetings = [];
        renderBoard(rooms, todayMeetings);
      });
    }

    function initialize(){
      unsubRooms = subscribeRooms();
      unsubToday = subscribeToday();
    }
    initialize();

    // รีเฟรช section/เวลา ทุก 30 วินาที (progress + "เพิ่งจบ")
    setInterval(()=> renderBoard(rooms, todayMeetings), 30_000);

    // ปุ่มเต็มจอ (ลอย)
    $("#btnFullscreen").addEventListener("click", ()=>{
      if (!document.fullscreenElement) document.documentElement.requestFullscreen().catch(()=>{});
      else document.exitFullscreen().catch(()=>{});
    });

    // คีย์ลัดเฉพาะเต็มจอ
    document.addEventListener("keydown", (e)=>{
      if (e.key === "F11"){
        e.preventDefault();
        $("#btnFullscreen").click();
      }
    });
  </script>
</body>
</html>
