<!doctype html>
<html lang="th" data-bs-theme="light">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Dashboard • สถานะห้องประชุม</title>

  <!-- Bootstrap + Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet"/>
  
  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet"/>

  <style>
    :root{
      --radius: 20px;
      --shadow: 0 8px 32px rgba(0,0,0,.08), 0 4px 16px rgba(0,0,0,.04);
      --shadow-hover: 0 12px 48px rgba(0,0,0,.12), 0 8px 24px rgba(0,0,0,.08);
      --ring: 0 0 0 3px rgba(13,110,253,.15);
      --gradient-bg: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
      --glass: rgba(255,255,255,.95);
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif; overflow-x: auto; }
    body { margin: 0; background: var(--gradient-bg); background-attachment: fixed; position: relative; }
    body::before {
      content: ''; position: fixed; inset: 0; pointer-events: none; z-index: -1;
      background:
        radial-gradient(circle at 20% 20%, rgba(255,255,255,.05) 0%, transparent 50%),
        radial-gradient(circle at 80% 80%, rgba(255,255,255,.03) 0%, transparent 50%);
    }

    /* Container หลัก */
    .board { 
      height: 100vh; 
      padding: 12px; 
      display: flex; 
      flex-direction: column; 
      overflow: hidden; /* ป้องกัน scroll */
    }

    /* Header */
    .board-head{
      display:flex; align-items:center; justify-content:space-between; gap:16px;
      margin-bottom:16px; background:var(--glass); backdrop-filter: blur(20px);
      border:1px solid rgba(255,255,255,.3); border-radius:var(--radius);
      padding:12px 20px; box-shadow:var(--shadow); flex-wrap: wrap;
      flex-shrink: 0; /* ไม่ให้ header หดตัว */
    }

    .now-chip{
      background: linear-gradient(135deg,#667eea,#764ba2); color:#fff; border:none;
      border-radius:12px; padding:10px 16px; font-weight:800; font-size:1.1rem;
      box-shadow:0 4px 16px rgba(102,126,234,.3); font-variant-numeric: tabular-nums; letter-spacing:.5px;
      display:block; width:100%; text-align:center;
      line-height:1.2;
    }
    .now-chip i{ opacity:.9; margin-right:6px; font-size:1.1em; }
    .now-chip .sep{ opacity:.6; margin: 0 .6rem; }
    .util{ display:flex; align-items:center; gap:8px; flex: 0 0 100%; width:100%; }

    /* Grid การ์ด - ปรับให้พอดี 1 หน้า */
    .rooms-grid{ 
      display: grid; 
      grid-template-columns: repeat(auto-fit, minmax(300px,1fr)); 
      gap: 16px; 
      flex: 1; 
      overflow: hidden; /* ป้องกัน scroll */
      align-content: start;
    }
    
    /* ปรับ grid ตามขนาดหน้าจอ */
    @media (min-width: 768px) and (max-width: 1199px) { 
      .rooms-grid{ grid-template-columns: repeat(2, 1fr); } 
    }
    @media (min-width: 1200px) and (max-width: 1599px) { 
      .rooms-grid{ grid-template-columns: repeat(3, 1fr); } 
    }
    @media (min-width: 1600px) and (max-width: 1999px) { 
      .rooms-grid{ grid-template-columns: repeat(4, 1fr); } 
    }
    @media (min-width: 2000px) { 
      .rooms-grid{ grid-template-columns: repeat(5, 1fr); } 
    }

    /* การ์ดห้อง - ระบบย่อขนาดอัตโนมัติ */
    .room-card{
      --h:210; 

      background: #ffffff; /* พื้นหลังสีขาวธรรมดา */
      border: 3px solid transparent;
      border-radius: var(--radius);
      padding: clamp(8px, 2vw, 16px); /* padding ปรับตามหน้าจอ */
      box-shadow: var(--shadow); 
      transition: all .4s cubic-bezier(.4,0,.2,1);
      position: relative; 
      overflow: visible; /* เปลี่ยนเป็น visible เพื่อให้เห็นเนื้อหาทั้งหมด */
      height: calc((100vh - 100px) / 2 - 8px); /* เพิ่มพื้นที่ให้การ์ด */
      min-height: 280px; /* ลดความสูงขั้นต่ำ */
      max-height: 400px; /* เพิ่มความสูงสูงสุด */
      display: flex; 
      flex-direction: column;
      opacity: 0; 
      transform: translateY(8px);
      animation: fadeUp .5s ease forwards;
      background-image: linear-gradient(90deg, hsl(var(--h), 70%, 60%), hsl(var(--h), 80%, 70%), hsl(var(--h), 70%, 60%));
      background-size: 200% 100%;
      background-clip: border-box;
      animation: neonBorder 3s ease-in-out infinite, fadeUp .5s ease forwards;

    }
    
    @keyframes fadeUp{ to{ opacity:1; transform: translateY(0); } }
    
    /* เอฟเฟกต์แสงนีออนวิ่งรอบกรอบ */
    @keyframes neonBorder {
      0%, 100% {
        background-position: 0% 50%;
        box-shadow: 
          0 0 20px hsla(var(--h), 70%, 60%, 0.4),
          0 0 40px hsla(var(--h), 70%, 60%, 0.2),
          inset 0 0 20px hsla(var(--h), 70%, 60%, 0.1);
      }
      50% {
        background-position: 100% 50%;
        box-shadow: 
          0 0 30px hsla(var(--h), 70%, 60%, 0.6),
          0 0 60px hsla(var(--h), 70%, 60%, 0.3),
          inset 0 0 30px hsla(var(--h), 70%, 60%, 0.15);
      }
    }

    .room-card::before{ 
      content:''; 
      position:absolute; 
      top:3px; left:3px; right:3px; bottom:3px;
      background: #ffffff; /* พื้นหลังด้านในสีขาว */
      border-radius: calc(var(--radius) - 3px);
      z-index: 1;
    }
    
    .room-card > * {
      position: relative;
      z-index: 2;
    }
    
    .room-card:hover{ 
      transform: translateY(-8px); 
      animation-duration: 2s; /* เร็วขึ้นเมื่อ hover */
    }

    .room-title{ 
      display:flex; 
      align-items:center; 
      justify-content:space-between; 
      flex-wrap:wrap; 
      margin-bottom: clamp(6px, 1vh, 12px); 
      gap: clamp(4px, 1vw, 8px); 
    }
    
    .room-name{ 
      display:flex; 
      align-items:center; 
      gap: clamp(6px, 1vw, 12px); 
      font-weight:900; 
      font-size: clamp(1.2rem, 3vw, 1.8rem); /* ปรับขนาดตามหน้าจอ */
      color:#1a1a1a; /* สีดำเข้มเพื่อความชัดเจน */
      line-height: 1.1;
    }
    
    .room-name .color-dot{ 
      width:16px; 
      height:16px; 
      border-radius:50%; 
      background:hsl(var(--h),70%,55%); 
      box-shadow:0 0 0 6px hsla(var(--h),70%,55%,.2); 
      animation:pulse-room 2s ease-in-out infinite; 
    }
    
    @keyframes pulse-room{ 
      0%,100%{
        box-shadow:0 0 0 8px hsla(var(--h),70%,55%,.2);
        transform: scale(1);
      } 
      50%{
        box-shadow:0 0 0 16px hsla(var(--h),70%,55%,.4);
        transform: scale(1.1);
      } 
    }

    .meta-info{ display:flex; gap:8px; flex-wrap:wrap; margin-bottom:8px; }
    .meta-pill{ 
      background: #f8f9fa; 
      color: #495057; 
      border: 1px solid #dee2e6; 
      border-radius: 16px; 
      padding: 4px 8px; 
      font-size: 0.8rem; 
      font-weight: 600; 
    }

    .live-pill{ 
      display: inline-flex; 
      align-items: center; 
      gap: clamp(4px, 1vw, 8px); 
      padding: clamp(6px, 1.5vw, 10px) clamp(8px, 2vw, 16px); 
      border-radius: clamp(12px, 2vw, 20px); 
      font-weight: 900; 
      font-size: clamp(1rem, 2.5vw, 1.4rem); /* ปรับขนาดตามหน้าจอ */
      border: 2px solid; 
      transition: all .3s ease; 
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .live-pill .beacon{ 
      width: 12px; 
      height: 12px; 
      border-radius: 50%; 
    }
    
    .live-free{ 
      background: #d4edda; 
      border-color: #28a745; 
      color: #155724; 
    }
    
    .live-free .beacon{ 
      background: #28a745; 
      animation: pulseFree 1.5s infinite; 
      box-shadow: 0 0 0 0 rgba(40,167,69,.7);
    }
    
    .live-busy{ 
      background: #f8d7da; 
      border-color: #dc3545; 
      color: #721c24; 
    }
    
    .live-busy .beacon{ 
      background: #dc3545; 
      animation: pulseBusy 1.5s infinite; 
      box-shadow: 0 0 0 0 rgba(220,53,69,.7);
    }
    
    @keyframes pulseFree{ 
      0%{
        box-shadow: 0 0 0 0 rgba(40,167,69,.7);
        transform: scale(1);
      } 
      70%{
        box-shadow: 0 0 0 10px rgba(40,167,69,0);
        transform: scale(1.2);
      } 
      100%{
        box-shadow: 0 0 0 0 rgba(40,167,69,0);
        transform: scale(1);
      } 
    }
    
    @keyframes pulseBusy{ 
      0%{
        box-shadow: 0 0 0 0 rgba(220,53,69,.7);
        transform: scale(1);
      } 
      70%{
        box-shadow: 0 0 0 10px rgba(220,53,69,0);
        transform: scale(1.2);
      } 
      100%{
        box-shadow: 0 0 0 0 rgba(220,53,69,0);
        transform: scale(1);
      } 
    }

    .section-label{ 
      display: flex; 
      align-items: center; 
      gap: clamp(3px, 0.8vw, 6px); 
      font-weight: 900; 
      font-size: clamp(0.8rem, 1.8vw, 1rem); /* ปรับขนาดตามหน้าจอ */
      color: #2c3e50; 
      margin: clamp(4px, 1vh, 8px) 0 clamp(3px, 0.8vh, 6px); 
      position: relative;
      width: 100%; /* กำหนดความกว้างให้ชัดเจน */
      box-sizing: border-box; /* รวม padding/border ในการคำนวณ */
    }
    
    .section-label i{ 
      opacity: .9; 
      font-size: 1.1em;
      flex-shrink: 0; /* ป้องกัน icon หดตัว */
    }
    
    .section-label::after{ 
      content: ""; 
      width: 60px; /* กำหนดความกว้างคงที่ */
      height: 2px; 
      background: linear-gradient(90deg, hsla(var(--h),60%,60%,.6), transparent); 
      border-radius: 1px;
      margin-left: auto; /* ดันไปขวา */
      flex-shrink: 0; /* ป้องกันหดตัว */
    }

    .section-content{ 
      flex: 1; 
      display: flex; 
      flex-direction: column; 
      gap: clamp(2px, 0.5vh, 4px); /* gap ปรับตามหน้าจอ */
      overflow: visible; /* เปลี่ยนเป็น visible */
      min-height: 0; /* ให้ flex item สามารถหดได้ */
      max-height: calc(100% - clamp(80px, 15vh, 120px)); /* ปรับตามหน้าจอ */
    }

    .status-item{ 
      display: flex; 
      align-items: center; 
      justify-content: space-between; 
      gap: clamp(3px, 0.8vw, 6px); 
      background: #f8f9fa; 
      border: 1px solid #e9ecef; 
      border-radius: clamp(4px, 1vw, 8px); 
      padding: clamp(3px, 1vh, 6px) clamp(5px, 1.5vw, 10px); /* ปรับตามหน้าจอ */
      transition: all .25s ease; 
      font-size: clamp(0.7rem, 1.5vw, 0.9rem); /* เพิ่มการควบคุมขนาดฟอนต์ */
    }
    
    .status-item:hover{ 
      background: #e9ecef; 
      transform: translateX(4px); 
      border-color: #adb5bd;
    }
    
    .status-left{ 
      display: flex; 
      align-items: center; 
      gap: 8px; 
      min-width: 0; 
    }
    
    .status-left i{ 
      opacity: .8; 
      font-size: 1em;
    }
    
    .status-time{ 
      font-variant-numeric: tabular-nums; 
      font-weight: 800; 
      padding: clamp(2px, 0.8vh, 4px) clamp(4px, 1.2vw, 8px); 
      border-radius: clamp(3px, 0.8vw, 6px); 
      background: #ffffff; 
      border: 1px solid hsl(var(--h),60%,60%); 
      color: hsl(var(--h),40%,30%); 
      font-size: clamp(0.7rem, 1.4vw, 0.85rem); /* ปรับขนาดตามหน้าจอ */
    }
    
    .status-who{ 
      color: #495057; 
      font-size: clamp(0.7rem, 1.4vw, 0.85rem); /* ปรับขนาดตามหน้าจอ */
      white-space: nowrap; 
      overflow: hidden; 
      text-overflow: ellipsis; 
      max-width: 60%; 
      font-weight: 600; 
    }

    .progress-wrap{ 
      background: #e9ecef; 
      border: 1px solid #dee2e6; 
      border-radius: 8px; 
      height: 8px; 
      overflow: hidden; 
      margin-top: 4px; 
    }
    
    .progress-bar{ 
      height: 100%; 
      background: linear-gradient(90deg, hsl(var(--h),60%,55%), hsl(var(--h),70%,65%)); 
      transition: width .3s ease; 
      border-radius: 8px; 
      position: relative;
    }
    
    .progress-bar::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
      animation: shimmer 2s infinite;
    }
    
    @keyframes shimmer {
      0% { transform: translateX(-100%); }
      100% { transform: translateX(100%); }
    }

    /* ป้ายเพิ่งจบ */
    .badge-soft{
      display: inline-flex; 
      align-items: center; 
      gap: 4px; 
      padding: 4px 8px; 
      border-radius: 12px; 
      font-weight: 700; 
      font-size: 0.75rem; 
      background: #f8f9fa; 
      border: 1px solid #dee2e6; 
      color: #495057;
    }
    
    .badge-soft i{ 
      opacity: .8; 
      font-size: 1em;
    }

    /* ปุ่มลอย (เต็มจอ) */
    .fab{
      position: fixed; right: 20px; bottom: 20px; z-index: 9999;
      background: var(--glass); backdrop-filter: blur(12px);
      border: 1px solid rgba(255,255,255,.5);
      border-radius: 999px; padding: 12px 16px;
      font-weight: 700; box-shadow: var(--shadow); cursor: pointer;
      display: inline-flex; align-items:center; gap:8px;
    }
    .fab:hover{ box-shadow: var(--shadow-hover); transform: translateY(-2px); }
    .fab:focus-visible{ outline:0; box-shadow: var(--ring); }

    /* Empty State */
    .empty-state {
      text-align: center;
      color: #6c757d;
      font-size: 0.9rem;
      font-weight: 600;
      padding: 8px;
      font-style: italic;
    }

    /* More Items Indicator */
    .more-items {
      text-align: center;
      color: #6c757d;
      font-size: clamp(0.6rem, 1.2vw, 0.8rem);
      font-weight: 600;
      padding: clamp(2px, 0.8vh, 4px) clamp(4px, 1.2vw, 8px);
      margin-top: clamp(2px, 0.5vh, 4px);
      background: #f8f9fa;
      border: 1px dashed #dee2e6;
      border-radius: clamp(3px, 0.8vw, 6px);
      font-style: italic;
    }



    /* Responsive */
    @media (max-width:768px){
      .rooms-grid{ 
        grid-template-columns: 1fr; 
        gap: 12px; 
      }
      .board{ padding: 8px; }
      .board-head{ padding: 8px 12px; }
      .room-card{ 
        height: calc((100vh - 100px) / 3 - 8px); /* 3 แถวในมือถือ */
        min-height: 200px;
        max-height: 250px;
      }
      .room-name{ font-size: 1.4rem; }
      .live-pill{ font-size: 1.1rem; padding: 8px 12px; }
      .section-label{ font-size: 1rem; }
    }
    
    @media (max-width:480px){
      .room-name{ font-size: 1.2rem; }
      .live-pill{ font-size: 1rem; padding: 6px 10px; }
      .section-label{ font-size: 0.9rem; }
      .room-card{ 
        height: calc((100vh - 80px) / 4 - 6px); /* 4 แถวในหน้าจอเล็ก */
        min-height: 160px;
        max-height: 200px;
      }
    }
  </style>
</head>
<body>
  <main class="board">
    <div class="board-head">
      <div class="util">
        <span id="nowTime" class="now-chip">
          <i class="bi bi-calendar3"></i> — — — <span class="sep">•</span><i class="bi bi-clock"></i> —:— น.
        </span>
      </div>
    </div>

    <div id="roomsGrid" class="rooms-grid"></div>
  </main>

  <!-- ปุ่มลอยมุมขวาล่าง -->
  <button id="btnFullscreen" class="fab">
    <i class="bi bi-arrows-fullscreen"></i> เต็มจอ
  </button>

  <!-- Firebase (ESM) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-app.js";
    import { getFirestore, collection, onSnapshot, query, orderBy, where } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-firestore.js";

    /* ============== CONFIG ============== */
    const firebaseConfig = {
      apiKey: "AIzaSyB_G4hfiis6DjmPiwsh5-hnNKVztMfd_T4",
      authDomain: "booking-sw.firebaseapp.com",
      projectId: "booking-sw",
      storageBucket: "booking-sw.firebasestorage.app",
      messagingSenderId: "134246403096",
      appId: "1:134246403096:web:900da94277e8b70c4cc76d"
    };

    /* ============== INIT ============== */
    const app = initializeApp(firebaseConfig);
    const db  = getFirestore(app);
    const roomsRef = collection(db, "meeting_rooms");
    const meetingsRef = collection(db, "meetings");

    const $ = (s) => document.querySelector(s);
    const nowEl = $("#nowTime");
    const grid = $("#roomsGrid");

    const fmt2 = (n) => String(n).padStart(2,"0");
    const toYmd = (d) => [d.getFullYear(), fmt2(d.getMonth()+1), fmt2(d.getDate())].join("-");
    const hm2m = (s) => { const [h,m] = (s||"0:0").split(":").map(x => +x||0); return h*60+m; };
    const clamp = (v,min,max)=> Math.max(min, Math.min(max,v));

    /* ===== เวลา: แสดงวันที่ + เวลา (ไทย) ===== */
    function thaiDateString(d){
      // เช่น "พฤหัสบดี 11 ก.ย. 2568"
      const opts = { weekday:'long', year:'numeric', month:'short', day:'numeric' };
      // th-TH จะเป็น พ.ศ. โดยอัตโนมัติ
      return d.toLocaleDateString('th-TH', opts);
    }
    function tickClock(){
      const d = new Date();
      const timeTxt = `${fmt2(d.getHours())}:${fmt2(d.getMinutes())}`;
      nowEl.innerHTML = `<i class="bi bi-calendar3"></i> ${thaiDateString(d)} <span class="sep">•</span> <i class="bi bi-clock"></i> ${timeTxt} น.`;
    }
    tickClock();
    setInterval(tickClock, 1_000);

    /* ===== UI Builders ===== */
    function hueFromString(s){
      if(!s) return 210;
      let h=0; for(let i=0;i<s.length;i++){ h=(h*31 + s.charCodeAt(i)) % 360; }
      return Math.round((h/360)*330);
    }

    function makeSectionLabel(icon, text, h){
      const div=document.createElement("div");
      div.className="section-label";
      div.style.setProperty("--h", h);
      div.innerHTML=`<i class="bi ${icon}"></i> ${text}`;
      return div;
    }

    function makeStatusItem(h, timeText, whoText, leadingIcon=null, trailingNode=null){
      const wrap=document.createElement("div");
      wrap.className="status-item";
      wrap.style.setProperty("--h", h);

      const left=document.createElement("div");
      left.className="status-left";
      if (leadingIcon){
        const ic = document.createElement("i");
        ic.className = `bi ${leadingIcon}`;
        left.appendChild(ic);
      }

      const time=document.createElement("span");
      time.className="status-time";
      time.textContent=timeText;

      const who=document.createElement("div");
      who.className="status-who";
      who.textContent=(whoText||"").trim() || "—";

      left.appendChild(time);
      left.appendChild(who);
      wrap.appendChild(left);

      if (trailingNode) wrap.appendChild(trailingNode);
      return wrap;
    }

    function makeProgress(h, startHM, endHM){
      const from = hm2m(startHM), to = hm2m(endHM);
      const nowM = (new Date()).getHours()*60 + (new Date()).getMinutes();
      const pct = clamp(((nowM - from) / (to - from)) * 100, 0, 100);

      const wrap=document.createElement("div");
      wrap.className="progress-wrap";
      wrap.style.setProperty("--h", h);

      const bar=document.createElement("div");
      bar.className="progress-bar";
      bar.style.width = `${isFinite(pct)?pct:0}%`;

      wrap.appendChild(bar);
      return wrap;
    }

    function makeEmptyState(text){
      const div=document.createElement("div");
      div.className="empty-state";
      div.textContent=text;
      return div;
    }



    /* ====== Render ====== */
    function renderBoard(rooms, meetingsToday){
      grid.innerHTML="";

      // กลุ่มห้อง
      const grouped={};
      rooms.forEach(r=> grouped[r.id]={ meta:r, prev:[], now:[], next:[] });

      // ใส่ meetings วันนี้
      const now = new Date();
      const nowM = now.getHours()*60 + now.getMinutes();

      meetingsToday.forEach(m=>{
        const rid = m.roomId || `misc:${m.roomName || "ห้อง"}`;
        if(!grouped[rid]) grouped[rid] = { meta:{ id:rid, name:m.roomName || "(ไม่มีชื่อ)" }, prev:[], now:[], next:[] };
        const s=hm2m(m.start), e=hm2m(m.end);
        
        // Debug: แสดงข้อมูลการจัดกลุ่ม
        console.log(`Meeting: ${m.roomName} ${m.start}-${m.end}, nowM: ${nowM}, s: ${s}, e: ${e}`);
        
        if(e<=nowM) {
          grouped[rid].prev.push(m);
          console.log(`-> Added to PREV: ${m.start}-${m.end}`);
        }
        else if(s<=nowM && nowM<e) {
          grouped[rid].now.push(m);
          console.log(`-> Added to NOW: ${m.start}-${m.end}`);
        }
        else {
          grouped[rid].next.push(m);
          console.log(`-> Added to NEXT: ${m.start}-${m.end}`);
        }
      });

      // วาดการ์ดตามชื่อ
      Object.values(grouped)
        .sort((a,b)=> (a.meta?.name||"").localeCompare(b.meta?.name||""))
        .forEach(g=>{
          const name = g.meta?.name || "(ไม่มีชื่อ)";
          const floor = g.meta?.location ?? g.meta?.floor ?? g.meta?.level ?? null;
          const cap   = g.meta?.capacity ?? g.meta?.cap ?? null;
          
          // Debug: แสดงข้อมูลห้องใน console
          console.log('Room data:', g.meta?.name, 'Floor:', floor, 'Raw data:', g.meta);
          console.log(`Room ${name}: prev=${g.prev.length}, now=${g.now.length}, next=${g.next.length}`);
          const h = hueFromString(g.meta?.id || name);

          const card=document.createElement("div");
          card.className="room-card";
          card.style.setProperty("--h", h);

          const title=document.createElement("div");
          title.className="room-title";

          const nameDiv=document.createElement("div");
          nameDiv.className="room-name";
          // แสดงชื่อห้องพร้อม floor ในวงเล็บสีเทา
          const floorHtml = floor ? ` <small class="text-secondary">(ชั้น ${floor})</small>` : '';
          nameDiv.innerHTML=`<span class="color-dot"></span><span>${name}${floorHtml}</span>`;

          const live=document.createElement("span");
          const busy = g.now.length>0;
          live.className = `live-pill ${busy? "live-busy":"live-free"}`;
          live.innerHTML = `<span class="beacon"></span>${busy? "ไม่ว่าง":"ว่างตอนนี้"}`;

          title.appendChild(nameDiv);
          title.appendChild(live);
          card.appendChild(title);

          if (floor || cap){
            const meta=document.createElement("div");
            meta.className="meta-info";
            if (floor) meta.innerHTML += `<span class="meta-pill"><i class="bi bi-building"></i> ชั้น ${floor}</span>`;
            if (cap || cap===0) meta.innerHTML += `<span class="meta-pill"><i class="bi bi-people"></i> ${cap} คน</span>`;
            meta.innerHTML += `<span class="meta-pill"><i class="bi bi-calendar3"></i> วันนี้</span>`;
            card.appendChild(meta);
          }

          const content=document.createElement("div");
          content.className="section-content";

          /* ก่อนหน้า: โชว์ 1 รายการล่าสุดที่เพิ่งจบ */
          const prevSec=document.createElement("div");
          const prevLabel = g.prev.length > 0 ? `ก่อนหน้า (${g.prev.length})` : "ก่อนหน้า";
          prevSec.appendChild(makeSectionLabel("bi-clock-history", prevLabel, h));
          if (g.prev.length){
            // ล่าสุด = จบช้าที่สุด
            g.prev.sort((a,b)=> (a.end||"").localeCompare(b.end||""));
            const lastMeeting = g.prev[g.prev.length-1];
            // แสดงเฉพาะรายการเดียว (ที่เพิ่งจบล่าสุด)
            prevSec.appendChild(makeStatusItem(h, `${lastMeeting.start}–${lastMeeting.end}`, lastMeeting.bookerName||lastMeeting.userName||"", "bi-person-check"));
          } else {
            prevSec.appendChild(makeEmptyState("—"));
          }
          content.appendChild(prevSec);

          /* ขณะนี้ */
          const nowSec=document.createElement("div");
          const nowLabel = g.now.length > 0 ? `ขณะนี้ (${g.now.length})` : "ขณะนี้";
          nowSec.appendChild(makeSectionLabel("bi-broadcast-pin", nowLabel, h));
          if (g.now.length){
            g.now.sort((a,b)=> (a.start||"").localeCompare(b.start||""));
            // แสดงเฉพาะรายการแรก (ที่เริ่มเร็วที่สุด)
            const currentMeeting = g.now[0];
            nowSec.appendChild(makeStatusItem(h, `${currentMeeting.start}–${currentMeeting.end}`, currentMeeting.bookerName||currentMeeting.userName||"", "bi-dot"));
            nowSec.appendChild(makeProgress(h, currentMeeting.start, currentMeeting.end));
          }else{
            nowSec.appendChild(makeEmptyState("ไม่มีการใช้งาน"));
          }
          content.appendChild(nowSec);

          /* ต่อไป */
          const nextSec=document.createElement("div");
          const nextLabel = g.next.length > 0 ? `หลังจากนี้ (${g.next.length})` : "หลังจากนี้";
          nextSec.appendChild(makeSectionLabel("bi-calendar-event", nextLabel, h));
          if (g.next.length){
            g.next.sort((a,b)=> (a.start||"").localeCompare(b.start||""));
            // แสดงเฉพาะรายการแรก (ที่จะถึงล่าสุด)
            const nextMeeting = g.next[0];
            nextSec.appendChild(makeStatusItem(h, `${nextMeeting.start}–${nextMeeting.end}`, nextMeeting.bookerName||nextMeeting.userName||"", "bi-chevron-right"));
          }else{
            nextSec.appendChild(makeEmptyState("ไม่มีการจองต่อ"));
          }
          content.appendChild(nextSec);

          card.appendChild(content);
          grid.appendChild(card);
        });
    }

    /* ============== DATA SUBSCRIPTIONS ============== */
    let rooms=[], todayMeetings=[];
    let unsubRooms, unsubToday;

    function subscribeRooms(){
      const qRooms = query(roomsRef, orderBy("name"));
      return onSnapshot(qRooms, snap=>{
        rooms = snap.docs.map(d=>({ id:d.id, ...d.data() })).filter(r=> r.isActive !== false);
        renderBoard(rooms, todayMeetings);
      });
    }

    function subscribeToday(){
      const today = toYmd(new Date());
      console.log('Subscribing to meetings for date:', today);
      const qToday = query(meetingsRef, where("date","==", today));
      return onSnapshot(qToday, snap=>{
        todayMeetings = snap.docs.map(d=>({ id:d.id, ...d.data() }));
        console.log('Today meetings loaded:', todayMeetings.length, todayMeetings);
        renderBoard(rooms, todayMeetings);
      }, _err=>{
        console.error('Error loading meetings:', _err);
        todayMeetings = [];
        renderBoard(rooms, todayMeetings);
      });
    }

    function initialize(){
      unsubRooms = subscribeRooms();
      unsubToday = subscribeToday();
    }
    initialize();

    // รีเฟรช section/เวลา ทุก 30 วินาที (progress + "เพิ่งจบ")
    setInterval(()=> renderBoard(rooms, todayMeetings), 30_000);

    // ปุ่มเต็มจอ (ลอย)
    $("#btnFullscreen").addEventListener("click", ()=>{
      if (!document.fullscreenElement) document.documentElement.requestFullscreen().catch(()=>{});
      else document.exitFullscreen().catch(()=>{});
    });

    // คีย์ลัดเฉพาะเต็มจอ
    document.addEventListener("keydown", (e)=>{
      if (e.key === "F11"){
        e.preventDefault();
        $("#btnFullscreen").click();
      }
    });
  </script>
</body>
</html>
