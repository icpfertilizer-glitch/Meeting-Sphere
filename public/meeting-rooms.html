<!doctype html>
<html lang="th" data-bs-theme="light">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Meeting Rooms ‚Ä¢ ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏´‡πâ‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°</title>

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>

  <!-- Optional shared styles/scripts -->
  <link href="assets/css/styles.css" rel="stylesheet" />
  <script src="assets/js/menu.js" defer></script>

  <style>
    :root{ --radius:16px; }
    body{ padding-top:72px; }
    .card{ border:0; box-shadow:0 6px 24px rgba(0,0,0,.08); border-radius:var(--radius); }
    .btn-soft{ background:var(--bs-secondary-bg); border:0; }
    .btn-soft:hover{ background:var(--bs-tertiary-bg); }
    .badge-dot{ display:inline-flex; align-items:center; gap:.4rem; }
    .badge-dot::before{ content:""; width:.5rem; height:.5rem; border-radius:50%; background:currentColor; display:inline-block; }
    .table td, .table th{ vertical-align: middle; }
    .empty{ color:var(--bs-secondary-color); }
  </style>
</head>
<body>

  <!-- Navbar -->
  <nav class="navbar navbar-expand-lg border-bottom fixed-top bg-body">
    <div class="container-fluid">
      <button id="menuFab" class="btn btn-link p-0 me-3" aria-label="‡πÄ‡∏°‡∏ô‡∏π" aria-expanded="false">
        <span class="menu-icon"></span><span class="menu-icon"></span><span class="menu-icon"></span>
      </button>
      <a class="navbar-brand fw-bold" href="#">Meeting Rooms</a>

      <div class="d-flex align-items-center gap-2 ms-auto">
        <span id="userDisplayName" class="fw-semibold text-primary">‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</span>
        <button id="btnLogout" class="btn btn-danger btn-sm">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
      </div>
    </div>
  </nav>

<!-- Sidebar Overlay -->
  <div id="menuOverlay" class="menu-overlay" aria-hidden="true">
    <aside class="menu-drawer shadow-lg">
      <div class="menu-header d-flex align-items-center justify-content-between mb-4">
        <h5 class="fw-bold mb-0">‡πÄ‡∏°‡∏ô‡∏π‡∏£‡∏∞‡∏ö‡∏ö</h5>
        <button id="menuClose" class="btn btn-outline-secondary btn-sm">‚úï</button>
      </div>
    <div class="menu-section">Dashboard</div>
      <ul class="menu-list list-unstyled">
        <li><a href="dashboard.html" class="menu-link"><span>üè†</span> Dashboard</a></li>
      </ul>

      <div class="menu-section">‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ</div>
      <ul class="menu-list list-unstyled">
        <li><a href="bookings.html" class="menu-link"><span>üôç</span> ‡∏à‡∏≠‡∏á‡∏´‡πâ‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°</a></li>
      </ul>

        <div class="menu-section" data-required-role="admin">‡∏™‡πà‡∏ß‡∏ô‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>
    <ul class="menu-list list-unstyled" data-required-role="admin">
    <li class="menu-dropdown">
        <button class="menu-link d-flex justify-content-between align-items-center w-100">
        <span>üë• ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</span>
        <span class="caret">‚ñæ</span>
        </button>
        <ul class="submenu list-unstyled">
        <li><a href="Admin.html" class="menu-link">- ‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå</a></li>
        <li><a href="meeting-rooms.html" class="menu-link">- ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏´‡πâ‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°</a></li>
        </ul>
    </li>
    <li>
        <a href="" class="menu-link"><span>‚öôÔ∏è</span> ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤</a>
    </li>
    </ul>


      <div class="menu-section">‡∏™‡πà‡∏ß‡∏ô‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</div>
      <ul class="menu-list list-unstyled">
        <li><a href="" class="menu-link"><span>üìä</span> ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°</a></li>
      </ul>

      <hr class="my-4">

      <div class="d-flex align-items-center gap-3">
        <div class="avatar-circle">U</div>
        <div>
          <div class="fw-semibold" id="menuUserName">‚Äî</div>
          <div class="text-secondary small">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏≠‡∏¢‡∏π‡πà</div>
        </div>
      </div>
    </aside>
  </div>

  <main class="container">
    <!-- Guard ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö role -->
    <div id="guard" class="alert alert-warning d-none" role="alert">
      ‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö <strong>‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö (admin)</strong> ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
    </div>

    <h2 class="mb-3">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏´‡πâ‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°</h2>

    <!-- ‡∏ü‡∏≠‡∏£‡πå‡∏° ‡πÄ‡∏û‡∏¥‡πà‡∏°/‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç -->
    <div class="card p-3 mb-4">
      <form id="roomForm" class="row g-3">
        <input type="hidden" id="roomId" value="" />
        <div class="col-md-4">
          <label class="form-label">‡∏ä‡∏∑‡πà‡∏≠‡∏´‡πâ‡∏≠‡∏á <span class="text-danger">*</span></label>
          <input type="text" id="name" class="form-control" required />
        </div>
        <div class="col-md-4">
          <label class="form-label">‡∏ä‡∏±‡πâ‡∏ô <span class="text-danger">*</span></label>
          <input type="text" id="location" class="form-control" placeholder="‡∏ä‡∏±‡πâ‡∏ô 2" required />
        </div>
        <div class="col-md-2">
          <label class="form-label">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏∏ (‡∏Ñ‡∏ô) <span class="text-danger">*</span></label>
          <input type="number" id="capacity" class="form-control" min="1" step="1" required />
        </div>
        <div class="col-md-2 d-flex align-items-end">
          <div class="form-check">
            <input class="form-check-input" type="checkbox" id="isActive" checked>
            <label class="form-check-label" for="isActive">‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</label>
          </div>
        </div>
        <div class="col-md-3">
          <label class="form-label">‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏ï‡πà‡πÄ‡∏ß‡∏•‡∏≤</label>
          <input type="time" id="startTime" class="form-control" value="08:00" />
        </div>
        <div class="col-md-3">
          <label class="form-label">‡∏ñ‡∏∂‡∏á‡πÄ‡∏ß‡∏•‡∏≤</label>
          <input type="time" id="endTime" class="form-control" value="17:00" />
        </div>
        <div class="col-12 d-flex gap-2">
          <button class="btn btn-primary" type="submit" id="btnSave">
            <span class="me-1">üíæ</span><span id="saveLabel">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</span>
          </button>
          <button class="btn btn-soft" type="button" id="btnReset">‡∏•‡πâ‡∏≤‡∏á‡∏ü‡∏≠‡∏£‡πå‡∏°</button>
        </div>
      </form>
    </div>

    <!-- ‡πÅ‡∏ñ‡∏ö‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤/‡∏Å‡∏£‡∏≠‡∏á -->
    <div class="d-flex flex-wrap gap-2 align-items-center mb-3">
      <div class="input-group" style="max-width:360px;">
        <span class="input-group-text">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</span>
        <input type="text" id="q" class="form-control" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏´‡πâ‡∏≠‡∏á / ‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà">
      </div>
      <div class="ms-auto d-flex gap-2">
        <select id="statusFilter" class="form-select" style="max-width:200px;">
          <option value="all">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
          <option value="active">‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</option>
          <option value="inactive">‡∏õ‡∏¥‡∏î‡πÑ‡∏ß‡πâ</option>
        </select>
        <button id="btnRefresh" class="btn btn-soft">‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä</button>
      </div>
    </div>

    <!-- ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ -->
    <div class="card p-0">
      <div class="table-responsive">
        <table class="table mb-0">
          <thead class="table-light">
            <tr>
              <th style="width:36px;"></th>
              <th>‡∏ä‡∏∑‡πà‡∏≠‡∏´‡πâ‡∏≠‡∏á</th>
              <th>‡∏ä‡∏±‡πâ‡∏ô</th>
              <th class="text-center" style="width:120px;">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏∏</th>
              <th class="text-center" style="width:180px;">‡πÄ‡∏ß‡∏•‡∏≤‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</th>
              <th class="text-center" style="width:140px;">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
              <th class="text-end" style="width:160px;">‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
            </tr>
          </thead>
          <tbody id="tbodyRooms">
            <tr><td colspan="7" class="text-center py-4 empty">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‚Ä¶</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </main>

  <!-- Toast -->
  <div class="position-fixed bottom-0 end-0 p-3" style="z-index:1080">
    <div id="toast" class="toast align-items-center text-bg-dark border-0" role="alert" aria-live="assertive" aria-atomic="true">
      <div class="d-flex">
        <div class="toast-body" id="toastBody">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
      </div>
    </div>
  </div>

  <!-- Firebase -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-auth.js";
    import {
      getFirestore, collection, addDoc, updateDoc, onSnapshot, query, orderBy,
      serverTimestamp, doc, getDoc
    } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-firestore.js";

    // ====== ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Firebase (‡∏õ‡∏£‡∏±‡∏ö‡∏ï‡∏≤‡∏°‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Å‡∏ï‡πå‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì) ======
    const firebaseConfig = {
      apiKey: "AIzaSyB_G4hfiis6DjmPiwsh5-hnNKVztMfd_T4",
      authDomain: "booking-sw.firebaseapp.com",
      projectId: "booking-sw",
      storageBucket: "booking-sw.firebasestorage.app",
      messagingSenderId: "134246403096",
      appId: "1:134246403096:web:900da94277e8b70c4cc76d"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getFirestore(app);

    const DEFAULT_ROLE = 'viewer';

    // ====== Utils ======
    const $ = (sel) => document.querySelector(sel);
    const $$ = (sel) => document.querySelectorAll(sel);
    const toastEl = $('#toast');
    let toast;
    document.addEventListener('DOMContentLoaded', () => {
      if (toastEl) {
        // bootstrap ‡∏°‡∏≤‡∏à‡∏≤‡∏Å bundle ‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á
        // eslint-disable-next-line no-undef
        toast = new bootstrap.Toast(toastEl, { delay: 1800 });
      }
    });
    const showToast = (msg) => {
      const el = $('#toastBody');
      if (el && toast) { el.textContent = msg; toast.show(); }
      console.log('[Toast]', msg);
    };

    function safeFirstLetter(name){
      if (typeof name !== 'string' || name.length === 0) return 'U';
      return name.charAt(0).toUpperCase();
    }

    function applyUserDisplay(name) {
      const display = (typeof name === 'string' && name) ? name : '‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ';
      const nameEl = $('#userDisplayName');
      if (nameEl) nameEl.textContent = display;
      const menuNameEl = $('#menuUserName');
      if (menuNameEl) menuNameEl.textContent = display;
      const avatar = document.querySelector('.avatar-circle');
      if (avatar) avatar.textContent = safeFirstLetter(display);
    }

    async function getUserData(uid){
      const snap = await getDoc(doc(db, 'users', uid));
      if(!snap.exists()) return { name:'‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ', role: DEFAULT_ROLE };
      const data = snap.data() || {};
      const role = (typeof data.role === 'string' ? data.role : DEFAULT_ROLE).toLowerCase();
      const name = (typeof data.name === 'string' && data.name) ? data.name : '‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ';
      return { name, role };
    }

    function applyRoleToUI(role){
      document.documentElement.setAttribute('data-role', role);
      // ‡∏ã‡πà‡∏≠‡∏ô element ‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏´‡∏ô‡∏î data-required-role ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå
      $$('[data-required-role]').forEach(el=>{
        const allowed = (el.getAttribute('data-required-role')||'').split(',').map(s=>s.trim().toLowerCase());
        el.style.display = allowed.includes(role) ? '' : 'none';
      });
      // guard ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏ô‡πâ‡∏≤
      if(role !== 'admin'){
        const guard = $('#guard');
        if (guard) guard.classList.remove('d-none');
        // ‡∏õ‡∏¥‡∏î‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ü‡∏≠‡∏£‡πå‡∏° (‡πÑ‡∏°‡πà‡πÅ‡∏ï‡∏∞‡∏õ‡∏∏‡πà‡∏° logout/‡πÄ‡∏°‡∏ô‡∏π)
        $$('#roomForm input, #roomForm button').forEach(el => {
          if (el.id !== 'btnRefresh') el.disabled = true;
        });
      }
    }

    // ====== Auth Guard ======
    onAuthStateChanged(auth, async (user)=>{
      if(!user){ window.location.href = 'index.html'; return; }
      try {
        const { name, role } = await getUserData(user.uid);
        window.currentUser = { user, role, name };
        applyUserDisplay(name);
        applyRoleToUI(role);
        initRoomsRealtime(); // ‡∏ó‡∏±‡πâ‡∏á admin ‡πÅ‡∏•‡∏∞ non-admin ‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏î‡πâ
      } catch (e) {
        console.error('Failed to load user data:', e);
        showToast('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ');
      }
    });

    const btnLogout = $('#btnLogout');
    if (btnLogout) {
      btnLogout.addEventListener('click', async ()=>{
        await signOut(auth);
        window.location.href = 'index.html';
      });
    }

    // ====== State ======
    const roomsRef = collection(db, 'meeting_rooms');
    let rooms = []; // cache ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏à‡∏≤‡∏Å onSnapshot

    // ====== Load realtime ======
    function initRoomsRealtime(){
      const qRooms = query(roomsRef, orderBy('name'));
      onSnapshot(qRooms, snap=>{
        rooms = snap.docs.map(d => ({ id: d.id, ...d.data() }));
        renderRooms();
      }, err => {
        console.error('onSnapshot error:', err);
        showToast('‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏Ñ‡∏£‡∏∑‡∏≠‡∏Ç‡πà‡∏≤‡∏¢)');
      });
    }

    // ====== Render ======
    function renderRooms(){
      const tbody = $('#tbodyRooms');
      if (!tbody) return;

      const qInput = $('#q');
      const statusSel = $('#statusFilter');
      const term = (qInput && qInput.value ? qInput.value : '').trim().toLowerCase();
      const status = (statusSel && statusSel.value) ? statusSel.value : 'all';

      let list = rooms.slice();

      if(term){
        list = list.filter(r =>
          String(r.name||'').toLowerCase().includes(term) ||
          String(r.location||'').toLowerCase().includes(term)
        );
      }
      if(status === 'active') list = list.filter(r => r.isActive !== false);
      if(status === 'inactive') list = list.filter(r => r.isActive === false);

      if(!list.length){
        tbody.innerHTML = `<tr><td colspan="7" class="text-center py-4 empty">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr>`;
        return;
      }

      tbody.innerHTML = list.map(r=>{
        const hasTimes = r.startTime && r.endTime;
        const timeStr = hasTimes ? `${r.startTime} - ${r.endTime}` : '‚Äî';
        const active = r.isActive !== false;
        const badge = active
          ? `<span class="badge bg-success-subtle text-success badge-dot"><span>‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</span></span>`
          : `<span class="badge bg-secondary-subtle text-secondary badge-dot"><span>‡∏õ‡∏¥‡∏î‡πÑ‡∏ß‡πâ</span></span>`;

        return `
          <tr>
            <td class="text-center">üè¢</td>
            <td class="fw-semibold">${escapeHTML(String(r.name||''))}</td>
            <td>${escapeHTML(String(r.location||''))}</td>
            <td class="text-center">${Number(r.capacity||0)}</td>
            <td class="text-center">${timeStr}</td>
            <td class="text-center">${badge}</td>
            <td class="text-end">
              <div class="btn-group">
                <button class="btn btn-sm btn-outline-primary" data-action="edit" data-id="${r.id}">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
                <button class="btn btn-sm ${active? 'btn-outline-warning':'btn-outline-success'}" data-action="toggle" data-id="${r.id}">
                  ${active? '‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô':'‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô'}
                </button>
              </div>
            </td>
          </tr>
        `;
      }).join('');
    }

    function escapeHTML(s=''){
      return s.replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
    }

    // ====== Form Handlers ======
    const btnReset = $('#btnReset');
    if (btnReset) btnReset.addEventListener('click', ()=> resetForm());

    function resetForm(){
      const idEl = $('#roomId');        if (idEl) idEl.value = '';
      const nameEl = $('#name');        if (nameEl) nameEl.value = '';
      const locEl = $('#location');     if (locEl) locEl.value = '';
      const capEl = $('#capacity');     if (capEl) capEl.value = '';
      const stEl = $('#startTime');     if (stEl) stEl.value = '08:00';
      const etEl = $('#endTime');       if (etEl) etEl.value = '17:00';
      const actEl = $('#isActive');     if (actEl) actEl.checked = true;
      const lbl = $('#saveLabel');      if (lbl) lbl.textContent = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å';
    }

    const roomForm = $('#roomForm');
    if (roomForm) {
      roomForm.addEventListener('submit', async (e)=>{
        e.preventDefault();
        const role = (window.currentUser && window.currentUser.role) ? window.currentUser.role : '';
        if(role !== 'admin'){
          showToast('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£');
          return;
        }

        const id        = ($('#roomId')?.value || '').trim();
        const name      = ($('#name')?.value || '').trim();
        const location  = ($('#location')?.value || '').trim();
        const capacity  = parseInt(($('#capacity')?.value || '0'), 10) || 0;
        const startTimeRaw = ($('#startTime')?.value || '').trim();
        const endTimeRaw   = ($('#endTime')?.value || '').trim();
        const isActive  = !!($('#isActive') && $('#isActive').checked);

        if(!name || !location || !capacity || capacity < 1){
          showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô');
          return;
        }

        // ‡∏™‡πà‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡πÅ‡∏ö‡∏ö "‡∏ó‡∏±‡πâ‡∏á‡∏Ñ‡∏π‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏™‡πà‡∏á‡πÄ‡∏•‡∏¢" ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ú‡πà‡∏≤‡∏ô Firestore Rules
        const sendTimes = (startTimeRaw && endTimeRaw);
        const payloadBase = {
          name, location, capacity, isActive,
          updatedAt: serverTimestamp()
        };
        const payload = sendTimes
          ? { ...payloadBase, startTime: startTimeRaw, endTime: endTimeRaw }
          : payloadBase;

        console.log('[Save payload]', payload);

        try{
          if(id){
            await updateDoc(doc(db, 'meeting_rooms', id), payload);
            showToast('‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏´‡πâ‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°‡πÅ‡∏•‡πâ‡∏ß');
          }else{
            await addDoc(roomsRef, { ...payload, createdAt: serverTimestamp() });
            showToast('‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡πâ‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°‡πÅ‡∏•‡πâ‡∏ß');
          }
          resetForm();
        }catch(err){
          console.error('Save error:', err);
          showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å (‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏´‡∏£‡∏∑‡∏≠‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á)');
        }
      });
    }

    // ‡∏ï‡∏≤‡∏£‡∏≤‡∏á: edit / toggle
    const tbodyRooms = $('#tbodyRooms');
    if (tbodyRooms) {
      tbodyRooms.addEventListener('click', async (e)=>{
        const btn = e.target.closest('button[data-action]');
        if(!btn) return;
        const id = btn.getAttribute('data-id');
        const action = btn.getAttribute('data-action');

        if(action === 'edit'){
          const r = rooms.find(x=>x.id===id);
          if(!r) return;
          const idEl = $('#roomId');     if (idEl) idEl.value = r.id;
          const nEl  = $('#name');       if (nEl)  nEl.value  = r.name || '';
          const lEl  = $('#location');   if (lEl)  lEl.value  = r.location || '';
          const cEl  = $('#capacity');   if (cEl)  cEl.value  = r.capacity || '';
          const stEl = $('#startTime');  if (stEl) stEl.value = r.startTime || '08:00';
          const etEl = $('#endTime');    if (etEl) etEl.value = r.endTime   || '17:00';
          const aEl  = $('#isActive');   if (aEl)  aEl.checked = (r.isActive !== false);
          const lbl  = $('#saveLabel');  if (lbl)  lbl.textContent = '‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï';
          window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        if(action === 'toggle'){
          const role = (window.currentUser && window.currentUser.role) ? window.currentUser.role : '';
          if(role !== 'admin'){
            showToast('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£');
            return;
          }
          const r = rooms.find(x=>x.id===id);
          if(!r) return;
          try{
            await updateDoc(doc(db, 'meeting_rooms', id), {
              isActive: !(r.isActive !== false),
              updatedAt: serverTimestamp()
            });
            showToast((r.isActive!==false) ? '‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß' : '‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß');
          }catch(err){
            console.error('Toggle error:', err);
            showToast('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÑ‡∏î‡πâ (‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏Ñ‡∏£‡∏∑‡∏≠‡∏Ç‡πà‡∏≤‡∏¢)');
          }
        }
      });
    }

    // ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤/‡∏Å‡∏£‡∏≠‡∏á/‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä
    const qInput = $('#q');
    if (qInput) qInput.addEventListener('input', renderRooms);
    const statusSel = $('#statusFilter');
    if (statusSel) statusSel.addEventListener('change', renderRooms);
    const btnRefresh = $('#btnRefresh');
    if (btnRefresh) btnRefresh.addEventListener('click', ()=> renderRooms());
  </script>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
